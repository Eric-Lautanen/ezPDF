<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
    <title>Universal PDF Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* iOS safe area padding */
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        html {
            height: -webkit-fill-available;
        }

        .header {
            background: #1a1a1a;
            border-bottom: 1px solid #2a2a2a;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #fff;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .container {
            display: flex;
            height: calc(100vh - 81px);
        }

        .sidebar {
            width: 320px;
            background: #1a1a1a;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #2a2a2a;
        }

        .sidebar-title {
            font-size: 13px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .page-count {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .add-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .paste-area-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .paste-label {
            font-size: 11px;
            color: #888;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .paste-textarea {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            color: #e0e0e0;
            padding: 10px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            max-height: 120px;
            transition: border-color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .paste-textarea::placeholder {
            color: #555;
            font-size: 11px;
        }

        .paste-textarea:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .paste-textarea:not(:placeholder-shown) {
            border-color: #4a9eff;
        }

        .sidebar-controls {
            padding: 20px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pages-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            /* Improve performance on mobile */
            will-change: scroll-position;
            transform: translateZ(0);
        }

        .page-item {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            padding: 12px;
            margin-bottom: 12px;
            cursor: move;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            touch-action: pan-y;
        }

        .page-item:active {
            cursor: grabbing;
        }

        .page-item:hover {
            border-color: #3a3a3a;
            background: #141414;
        }

        .page-item.selected {
            border-color: #4a9eff;
        }

        .page-item.dragging {
            opacity: 0.5;
        }

        .page-item.error {
            border-color: #ff4444;
        }

        .page-preview {
            width: 100%;
            height: 160px;
            max-height: 160px;
            background: #000;
            border: 1px solid #2a2a2a;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .page-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .page-preview pre {
            font-size: 8px;
            color: #666;
            padding: 8px;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: pre-wrap;
            width: 100%;
            height: 100%;
        }

        .page-preview .loading {
            color: #666;
            font-size: 12px;
        }

        .page-preview .error-icon {
            color: #ff4444;
            font-size: 32px;
        }

        .page-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-name {
            font-size: 13px;
            color: #e0e0e0;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 200px;
        }

        .page-size {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .page-actions {
            display: flex;
            gap: 8px;
        }

        .page-action-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
            transition: color 0.2s;
        }

        .page-action-btn:hover {
            color: #e0e0e0;
        }

        .page-action-btn.delete:hover {
            color: #ff4444;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
        }

        .preview-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            transform: translateZ(0);
            will-change: scroll-position;
        }

        .preview-container {
            background: #fff;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
            min-height: 600px;
            max-height: 80vh;
            padding: 60px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transform: translateZ(0);
        }

        .preview-container img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .preview-container pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #000;
            tab-size: 4;
            -moz-tab-size: 4;
        }

        .preview-container code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .code-header {
            background: #1e1e1e;
            color: #888;
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px 4px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-language {
            text-transform: uppercase;
            color: #4a9eff;
        }

        .code-container {
            margin-bottom: 16px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .empty-state {
            text-align: center;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .empty-state-hint {
            font-size: 13px;
            color: #555;
        }

        .btn {
            padding: 10px 20px;
            border: 1px solid #2a2a2a;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .btn:hover:not(:disabled) {
            background: #2a2a2a;
            border-color: #3a3a3a;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #4a9eff;
            border-color: #4a9eff;
            color: #fff;
        }

        .btn-primary:hover:not(:disabled) {
            background: #3a8eef;
            border-color: #3a8eef;
        }

        .btn-block {
            width: 100%;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .option-group select,
        .option-group input[type="text"] {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            color: #e0e0e0;
            padding: 8px 12px;
            font-size: 13px;
            min-width: 200px;
        }

        .option-group input[type="text"]:focus,
        .option-group select:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .option-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 13px;
            color: #e0e0e0;
            cursor: pointer;
        }

        #fileInput {
            display: none;
        }

        .drop-zone {
            border: 2px dashed #2a2a2a;
            padding: 40px;
            text-align: center;
            transition: all 0.2s;
            background: #0a0a0a;
        }

        .drop-zone.dragover {
            border-color: #4a9eff;
            background: #141414;
        }

        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .drop-zone-text {
            font-size: 14px;
            color: #888;
            margin-bottom: 16px;
        }

        .page-number {
            position: absolute;
            top: 12px;
            left: 12px;
            background: #000;
            color: #888;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
        }

        .no-pages {
            padding: 40px 20px;
            text-align: center;
            color: #555;
            font-size: 13px;
        }

        /* Tablet styles (768px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .sidebar {
                width: 280px;
            }

            .header {
                padding: 16px 24px;
            }

            .preview-container {
                padding: 40px;
            }
        }

        /* Hamburger Menu Button */
        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            padding: 8px;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            z-index: 1002;
            pointer-events: auto;
        }

        .hamburger-icon {
            width: 24px;
            height: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            pointer-events: none;
        }

        .hamburger-icon span {
            display: block;
            width: 100%;
            height: 2px;
            background: #e0e0e0;
        }

        /* Mobile landscape and small tablets (481px - 768px) */
        @media (max-width: 768px) {
            .hamburger-btn {
                display: block;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                width: 85%;
                max-width: 320px;
                height: 100vh;
                height: 100dvh;
                max-height: none;
                z-index: 1001;
                transform: translateX(-100%);
                transition: transform 0.3s ease-out;
                border-right: 1px solid #2a2a2a;
                border-left: none;
                border-bottom: none;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .container {
                display: flex;
                flex-direction: row;
                height: calc(100vh - 81px);
            }

            .main-content {
                flex: 1;
                width: 100%;
            }

            .header {
                padding: 12px 16px;
                flex-wrap: nowrap; /* Prevent stacking */
                justify-content: space-between;
            }

            .header h1 {
                font-size: 16px;
            }

            .header-actions {
                display: flex; /* Ensure side-by-side */
                gap: 8px;
                width: auto;      /* Don't force full width */
                margin-top: 0;    /* Remove the top margin */
            }

            .btn {
                font-size: 12px;
                padding: 8px 12px;
            }

            .container {
                flex-direction: row;
            }

            .sidebar-header {
                padding: 12px 16px;
            }

            .paste-textarea {
                font-size: 11px;
                min-height: 50px;
                max-height: 100px;
            }

            .pages-list {
                padding: 12px 16px;
                /* Enable smooth scrolling on mobile */
                touch-action: pan-y;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .page-item {
                padding: 10px;
                /* Allow vertical scrolling through items */
                touch-action: pan-y;
            }

            .page-preview {
                height: 120px;
                /* Prevent preview from interfering with scroll */
                overflow: hidden;
                pointer-events: none;
            }
            
            .page-action-btn {
                /* Re-enable interaction on buttons */
                pointer-events: auto;
            }

            .main-content {
                flex: 1;
                min-height: 400px;
            }

            .preview-area {
                padding: 20px 16px;
                /* Single scroll area on mobile */
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                touch-action: pan-y;
            }

            .preview-container {
                padding: 30px 20px;
                min-height: 400px;
                /* Remove nested scroll */
                max-height: none;
                overflow: visible;
            }
            
            .preview-container pre {
                /* No horizontal scroll, wrap instead */
                overflow-x: auto;
                overflow-y: visible;
                white-space: pre-wrap;
                word-wrap: break-word;
                max-width: 100%;
            }

            .option-group {
                width: 100%;
            }

            .option-group select,
            .option-group input[type="text"] {
                min-width: 100%;
                width: 100%;
            }

            .toast {
                left: 16px;
                right: 16px;
                max-width: calc(100% - 32px);
            }

            /* Improve touch targets */
            .btn {
                min-height: 44px;
            }

            .page-action-btn {
                padding: 8px;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .checkbox-label {
                min-height: 44px;
                align-items: center;
            }

            .option-group input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }
        }

        /* Mobile portrait (max 480px) */
        @media (max-width: 480px) {
            .header {
                padding: 10px 12px;
            }

            .header h1 {
                width: auto;
                margin-bottom: 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .header-actions {
                flex-direction: row;
                width: auto;
            }

            .btn {
                width: auto;
                white-space: nowrap;
            }

            .sidebar-header {
                padding: 10px 12px;
            }

            .sidebar-title {
                font-size: 11px;
            }

            .add-buttons {
                gap: 6px;
            }

            .pages-list {
                padding: 10px 12px;
            }

            .page-item {
                padding: 8px;
                margin-bottom: 8px;
            }

            .page-preview {
                height: 100px;
                margin-bottom: 8px;
            }

            .page-name {
                font-size: 12px;
                max-width: 150px;
            }

            .page-size {
                font-size: 10px;
            }

            .page-action-btn {
                font-size: 12px;
            }

            .preview-area {
                padding: 12px;
            }

            .preview-container {
                padding: 20px 12px;
                min-height: 300px;
            }

            .preview-container pre {
                font-size: 10px;
            }

            .option-label {
                font-size: 10px;
            }

            .option-group select,
            .option-group input[type="text"] {
                font-size: 12px;
                padding: 10px;
            }

            .empty-state-icon {
                font-size: 48px;
            }

            .empty-state-text {
                font-size: 16px;
            }

            .empty-state-hint {
                font-size: 12px;
            }

            .drop-zone {
                padding: 24px 12px;
            }

            .drop-zone-icon {
                font-size: 36px;
            }

            .drop-zone-text {
                font-size: 12px;
            }

            .modal-title {
                font-size: 16px;
            }
        }

        /* Extra small devices and very narrow viewports */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 13px;
            }

            .page-name {
                max-width: 120px;
            }

            .preview-container {
                padding: 16px 10px;
            }

            .btn {
                font-size: 10px;
                padding: 8px 10px;
            }
        }

        /* Landscape orientation optimizations for mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .container {
                flex-direction: row;
            }

            .sidebar {
                width: 280px;
                height: auto;
                max-height: calc(100vh - 60px);
                border-right: 1px solid #2a2a2a;
                border-bottom: none;
            }

            .header {
                padding: 8px 12px;
            }

            .header h1 {
                font-size: 14px;
            }

            .pages-list {
                max-height: calc(100vh - 180px);
            }

            .preview-area {
                padding: 12px;
            }

            .preview-container {
                padding: 20px;
                min-height: 200px;
            }

            .option-group {
                flex: 1;
                min-width: 150px;
            }
        }

        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .page-preview img {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }

        /* Print styles */
        @media print {
            .header,
            .sidebar,
            .btn,
            .toast,
            .modal-overlay {
                display: none !important;
            }

            .preview-container {
                box-shadow: none;
                padding: 0;
            }

            body {
                background: white;
            }
        }

        /* Dark mode support for devices that prefer it */
        @media (prefers-color-scheme: dark) {
            /* Already dark by default, but ensure consistency */
            body {
                background: #0a0a0a;
                color: #e0e0e0;
            }
        }

        /* Reduced motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn,
            .page-action-btn,
            .page-item {
                -webkit-tap-highlight-color: rgba(74, 158, 255, 0.2);
            }

            .btn:active,
            .page-action-btn:active {
                transform: scale(0.98);
            }

            /* Increase spacing for easier touch */
            .page-actions {
                gap: 12px;
            }

            /* Make scrollable areas more obvious */
            .pages-list,
            .preview-area {
                -webkit-overflow-scrolling: touch;
            }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 12px 20px;
            font-size: 13px;
            color: #e0e0e0;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            pointer-events: none;
            z-index: 1000;
            max-width: 400px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            border-color: #52c41a;
            color: #52c41a;
        }

        .toast.error {
            border-color: #ff4444;
            color: #ff4444;
        }

        .toast.warning {
            border-color: #faad14;
            color: #faad14;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        table th,
        table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }

        table th {
            background: #f0f0f0;
            font-weight: 600;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #2a2a2a;
            border-top: 2px solid #4a9eff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #fff;
        }

        .modal-content {
            font-size: 14px;
            color: #e0e0e0;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="hamburger-btn" id="hamburgerBtn">
            <div class="hamburger-icon">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
        <h1>PDF Converter</h1>
        <div class="header-actions">
            <button class="btn" id="clearAllBtn" disabled>Clear All</button>
            <button class="btn btn-primary" id="exportBtn" disabled>
                <span id="exportBtnText">Export PDF</span>
            </button>
        </div>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Add Files</div>
                <div class="add-buttons">
                    <button class="btn btn-block" id="addFileBtn">
                        <span>üìÅ</span>
                        <span>Add File</span>
                    </button>
                    <div class="paste-area-container">
                        <label class="paste-label" for="pasteArea">üìã Paste Text or Image</label>
                        <textarea 
                            id="pasteArea" 
                            class="paste-textarea" 
                            placeholder="Paste text here (Ctrl/Cmd+V) or paste images..."
                            rows="3"
                        ></textarea>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="*/*" multiple capture="environment">
            </div>

            <div class="sidebar-controls">
                <div class="option-group">
                    <label class="option-label" for="pdfTitle">Document Title</label>
                    <input type="text" id="pdfTitle" placeholder="Untitled Document" maxlength="100">
                </div>
                <div class="option-group">
                    <label class="option-label" for="pageSize">Page Size</label>
                    <select id="pageSize">
                        <option value="a4">A4</option>
                        <option value="letter">Letter</option>
                        <option value="legal">Legal</option>
                    </select>
                </div>
                <div class="option-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="addPageNumbers">
                        <span>Add page numbers</span>
                    </label>
                </div>
            </div>

            <div class="pages-list" id="pagesList">
                <div class="sidebar-title">
                    Preview Pages
                    <div class="page-count" id="pageCount">0 pages</div>
                </div>
                <div class="no-pages">No pages added yet. Add files or paste content to begin.</div>
            </div>
        </div>

        <div class="main-content">
            <div class="preview-area" id="previewArea">
                <div class="empty-state">
                    <div class="empty-state-icon">üìÑ</div>
                    <div class="empty-state-text">No page selected</div>
                    <div class="empty-state-hint">Select a page from the sidebar to preview</div>
                </div>
            </div>
        </div>
    </div>

    <div class="drop-zone" id="dropZone" style="display: none;">
        <div class="drop-zone-icon">üìÑ</div>
        <div class="drop-zone-text">Drop files here</div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-title" id="modalTitle">Confirm</div>
            <div class="modal-content" id="modalContent"></div>
            <div class="modal-actions">
                <button class="btn" id="modalCancel">Cancel</button>
                <button class="btn btn-primary" id="modalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- pdfmake for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js" defer></script>
    <script>
        const MAX_FILE_SIZE = 50 * 1024 * 1024;
        const MAX_PAGES = 100;
        const MAX_IMAGE_DIMENSION = 5000;
        const SUPPORTED_IMAGE_TYPES = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/bmp'];
        const SUPPORTED_TEXT_EXTENSIONS = ['txt', 'md', 'rtf', 'log', 'js', 'py', 'html', 'css', 'json', 'xml', 'java', 'cpp', 'c', 'php', 'rb', 'go', 'rs', 'ts', 'jsx', 'tsx', 'sh', 'yml', 'yaml', 'csv', 'tsv'];

        const pages = [];
        let selectedPageId = null;
        let isProcessing = false;

        const elements = {
            sidebar: document.getElementById('sidebar'),
            hamburgerBtn: document.getElementById('hamburgerBtn'),
            pagesList: document.getElementById('pagesList'),
            previewArea: document.getElementById('previewArea'),
            addFileBtn: document.getElementById('addFileBtn'),
            pasteArea: document.getElementById('pasteArea'),
            fileInput: document.getElementById('fileInput'),
            exportBtn: document.getElementById('exportBtn'),
            exportBtnText: document.getElementById('exportBtnText'),
            clearAllBtn: document.getElementById('clearAllBtn'),
            pdfTitle: document.getElementById('pdfTitle'),
            pageSize: document.getElementById('pageSize'),
            addPageNumbers: document.getElementById('addPageNumbers'),
            toast: document.getElementById('toast'),
            dropZone: document.getElementById('dropZone'),
            pageCount: document.getElementById('pageCount'),
            modalOverlay: document.getElementById('modalOverlay'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            modalConfirm: document.getElementById('modalConfirm'),
            modalCancel: document.getElementById('modalCancel')
        };

        // Mobile Menu Handlers
        if (elements.hamburgerBtn && elements.sidebar) {
            let overlay = document.getElementById('sidebar-overlay-id');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'sidebar-overlay-id';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0); /* Invisible */
                    z-index: 1000; 
                    display: none;
                    -webkit-tap-highlight-color: transparent;
                `;
                document.body.appendChild(overlay);
            }

            const toggleMenu = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                const isOpen = elements.sidebar.classList.toggle('open');
                elements.hamburgerBtn.style.opacity = isOpen ? '0' : '1';
                elements.hamburgerBtn.style.pointerEvents = isOpen ? 'none' : 'auto';
                overlay.style.display = isOpen ? 'block' : 'none';
            };

            const closeMenu = () => {
                elements.sidebar.classList.remove('open');
                elements.hamburgerBtn.style.opacity = '1';
                elements.hamburgerBtn.style.pointerEvents = 'auto';
                overlay.style.display = 'none';
            };

            elements.hamburgerBtn.addEventListener('click', toggleMenu);
            elements.hamburgerBtn.addEventListener('touchend', toggleMenu);

            overlay.addEventListener('click', (e) => {
                e.preventDefault();
                closeMenu();
            });

            elements.sidebar.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            let touchStartX = 0;
            elements.sidebar.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
            }, { passive: true });

            elements.sidebar.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                if (touchStartX - touchEndX > 100) { // Swiped left
                    closeMenu();
                }
            });
        }

        // Validate all required elements exist (skip optional mobile elements)
        const optionalElements = ['sidebar', 'hamburgerBtn'];
        const missingElements = Object.entries(elements)
            .filter(([key, value]) => !value && !optionalElements.includes(key))
            .map(([key]) => key);
        
        if (missingElements.length > 0) {
            console.error('Missing required DOM elements:', missingElements);
            alert('Application initialization failed. Please refresh the page.');
        }

        const pageSizes = {
            a4: 'A4',
            letter: 'LETTER',
            legal: 'LEGAL'
        };

        // Helper function to estimate PDF pages based on content type
        function estimatePDFPages(page) {
            if (!page || !page.content) return 1;
            
            if (page.content.type === 'image') {
                return 1; // Images typically fit on one page
            } else if (page.content.type === 'table') {
                // Rough estimate: 25 rows per page (including header)
                const totalRows = page.content.rows.length + 1; // +1 for header
                return Math.ceil(totalRows / 25);
            } else if (page.content.type === 'text' || page.content.type === 'code') {
                const lines = page.content.data.split('\n');
                
                if (page.content.type === 'code') {
                    // Code: ~60 lines per page (9pt font, 1.4 line height, with margins)
                    return Math.ceil(lines.length / 60);
                } else {
                    // Plain text: ~50 lines per page (may have more wrapping)
                    return Math.ceil(lines.length / 50);
                }
            }
            return 1;
        }

        // Only attach event listeners if all elements exist
        if (!missingElements.length) {
            elements.addFileBtn.addEventListener('click', () => elements.fileInput.click());
            elements.pasteArea.addEventListener('paste', handleTextareaPaste);
            elements.pasteArea.addEventListener('input', handleTextareaInput);
            elements.fileInput.addEventListener('change', handleFileSelect);
            elements.exportBtn.addEventListener('click', exportPDF);
            elements.clearAllBtn.addEventListener('click', () => showConfirmModal('Clear All Pages', 'Are you sure you want to remove all pages? This action cannot be undone.', clearAll));
            elements.modalCancel.addEventListener('click', hideModal);
        }

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.dropZone.style.display = 'flex';
            elements.dropZone.style.position = 'fixed';
            elements.dropZone.style.top = '0';
            elements.dropZone.style.left = '0';
            elements.dropZone.style.width = '100%';
            elements.dropZone.style.height = '100%';
            elements.dropZone.style.zIndex = '9999';
            elements.dropZone.classList.add('dragover');
        });

        document.addEventListener('dragleave', (e) => {
            if (e.target === elements.dropZone) {
                elements.dropZone.classList.remove('dragover');
                elements.dropZone.style.display = 'none';
            }
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.dropZone.classList.remove('dragover');
            elements.dropZone.style.display = 'none';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleMultipleFiles(Array.from(files));
            }
        });

        // Handle orientation changes and resize for mobile devices
        let resizeTimeout;
        function handleResize() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Force re-render on orientation change to fix layout issues
                if (pages.length > 0) {
                    renderPages();
                }
            }, 250);
        }

        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', () => {
            setTimeout(handleResize, 100);
        });

        // Prevent zoom on double tap for better mobile UX
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });

        // Handle iOS keyboard to prevent viewport issues
        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
            const inputs = document.querySelectorAll('input[type="text"], select');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    setTimeout(() => {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
        }

        function validateFile(file) {
            if (!file || !(file instanceof File)) {
                return { valid: false, error: 'Invalid file object' };
            }

            if (file.size === 0) {
                return { valid: false, error: 'File is empty' };
            }

            if (file.size > MAX_FILE_SIZE) {
                return { valid: false, error: `File size exceeds ${MAX_FILE_SIZE / 1024 / 1024}MB limit` };
            }

            const ext = file.name.split('.').pop().toLowerCase();
            const isImage = SUPPORTED_IMAGE_TYPES.includes(file.type);
            const isText = SUPPORTED_TEXT_EXTENSIONS.includes(ext) || file.type.startsWith('text/');

            if (!isImage && !isText) {
                return { valid: false, error: 'Unsupported file format' };
            }

            return { valid: true };
        }

        function sanitizeFileName(filename) {
            if (!filename || typeof filename !== 'string') {
                return 'unnamed-file';
            }
            return filename.trim().substring(0, 255) || 'unnamed-file';
        }

        function sanitizeText(text) {
            if (!text || typeof text !== 'string') {
                return '';
            }
            return text.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g, '');
        }

        async function handleMultipleFiles(files) {
            if (isProcessing) {
                showToast('Please wait for current operation to complete', 'warning');
                return;
            }

            if (pages.length + files.length > MAX_PAGES) {
                showToast(`Cannot add files. Maximum ${MAX_PAGES} pages allowed`, 'error');
                return;
            }

            const validFiles = [];
            const errors = [];

            for (const file of files) {
                const validation = validateFile(file);
                if (validation.valid) {
                    validFiles.push(file);
                } else {
                    errors.push(`${file.name}: ${validation.error}`);
                }
            }

            if (errors.length > 0) {
                showToast(errors[0], 'error');
            }

            if (validFiles.length > 0) {
                isProcessing = true;
                for (const file of validFiles) {
                    await addPage(file);
                }
                isProcessing = false;
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleMultipleFiles(Array.from(files));
            }
            elements.fileInput.value = '';
        }

        // New paste handlers for textarea - no clipboard permissions needed
        async function handleTextareaPaste(e) {
            if (isProcessing) {
                e.preventDefault();
                showToast('Please wait for current operation to complete', 'warning');
                return;
            }

            if (pages.length >= MAX_PAGES) {
                e.preventDefault();
                showToast(`Maximum ${MAX_PAGES} pages reached`, 'error');
                return;
            }

            const items = e.clipboardData.items;

            // Check for images first
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (SUPPORTED_IMAGE_TYPES.includes(item.type)) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    if (blob && blob.size > 0) {
                        const file = new File([blob], 'pasted-image-' + Date.now() + '.png', { type: blob.type });
                        await addPage(file);
                        showToast('Image added from paste', 'success');
                        elements.pasteArea.value = '';
                        return;
                    }
                }
            }

            // If no image, let text paste through normally
            // The input handler will process it
        }

        async function handleTextareaInput(e) {
            const text = elements.pasteArea.value.trim();
            
            if (!text) return;

            if (isProcessing) {
                showToast('Please wait for current operation to complete', 'warning');
                return;
            }

            if (pages.length >= MAX_PAGES) {
                showToast(`Maximum ${MAX_PAGES} pages reached`, 'error');
                elements.pasteArea.value = '';
                return;
            }

            // Debounce to avoid processing while user is typing
            clearTimeout(elements.pasteArea.debounceTimer);
            elements.pasteArea.debounceTimer = setTimeout(async () => {
                const sanitized = sanitizeText(text);
                if (sanitized.length === 0) {
                    showToast('Text contains no valid content', 'error');
                    elements.pasteArea.value = '';
                    return;
                }

                const file = new File([sanitized], 'pasted-text-' + Date.now() + '.txt', { type: 'text/plain' });
                await addPage(file);
                showToast('Text added from paste area', 'success');
                elements.pasteArea.value = '';
            }, 500);
        }

        async function addPage(file) {
            const validation = validateFile(file);
            if (!validation.valid) {
                showToast(validation.error, 'error');
                return;
            }

            if (pages.length >= MAX_PAGES) {
                showToast(`Maximum ${MAX_PAGES} pages reached`, 'error');
                return;
            }

            const pageId = Date.now() + Math.random();
            const page = {
                id: pageId,
                file: file,
                name: sanitizeFileName(file.name),
                type: getFileType(file),
                content: null,
                thumbnailData: null,
                error: null,
                size: file.size
            };

            pages.push(page);
            renderPages();
            updateUIState();

            try {
                await processPageContent(page);
                renderPages();
                updateUIState(); // Enable export button now that content is loaded
                
                // Update the preview if this page is currently selected
                if (selectedPageId === pageId) {
                    renderPreview(page);
                } else if (pages.length === 1) {
                    // Auto-select first page
                    selectPage(pageId);
                }
            } catch (error) {
                console.error('Processing error:', error);
                page.error = error.message || 'Failed to process file';
                renderPages();
                updateUIState(); // Update UI even on error
                
                // Show error in preview if selected
                if (selectedPageId === pageId) {
                    elements.previewArea.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <div class="empty-state-text">Failed to load page</div>
                            <div class="empty-state-hint">${page.error}</div>
                        </div>
                    `;
                }
                
                showToast('Failed to process: ' + page.name, 'error');
            }
        }

        async function processPageContent(page) {
            if (!page || !page.file) {
                throw new Error('Invalid page object');
            }

            if (page.type === 'image') {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    const timeout = setTimeout(() => {
                        reader.abort();
                        reject(new Error('Image processing timeout'));
                    }, 30000);

                    reader.onload = (e) => {
                        clearTimeout(timeout);
                        if (!e.target.result) {
                            reject(new Error('Failed to read image data'));
                            return;
                        }

                        const img = new Image();
                        const imgTimeout = setTimeout(() => {
                            reject(new Error('Image load timeout'));
                        }, 10000);

                        img.onload = () => {
                            clearTimeout(imgTimeout);
                            
                            if (img.width === 0 || img.height === 0) {
                                reject(new Error('Invalid image dimensions'));
                                return;
                            }

                            if (img.width > MAX_IMAGE_DIMENSION || img.height > MAX_IMAGE_DIMENSION) {
                                reject(new Error(`Image dimensions exceed ${MAX_IMAGE_DIMENSION}px limit`));
                                return;
                            }

                            page.content = { 
                                type: 'image', 
                                data: e.target.result, 
                                width: img.width, 
                                height: img.height 
                            };
                            page.thumbnailData = e.target.result;
                            resolve();
                        };

                        img.onerror = () => {
                            clearTimeout(imgTimeout);
                            reject(new Error('Invalid or corrupted image'));
                        };

                        img.src = e.target.result;
                    };

                    reader.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('Failed to read file'));
                    };

                    reader.readAsDataURL(page.file);
                });
            } else if (page.type === 'text' || page.type === 'code') {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    const timeout = setTimeout(() => {
                        reader.abort();
                        reject(new Error('Text processing timeout'));
                    }, 15000);

                    reader.onload = (e) => {
                        clearTimeout(timeout);
                        if (!e.target.result) {
                            reject(new Error('Failed to read text data'));
                            return;
                        }

                        const text = sanitizeText(e.target.result);
                        if (text.length === 0) {
                            reject(new Error('File contains no valid text'));
                            return;
                        }

                        page.content = { type: 'text', data: text };
                        page.thumbnailData = text.substring(0, 200);
                        console.log('Text content processed:', text.length, 'characters');
                        resolve();
                    };

                    reader.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('Failed to read file'));
                    };

                    reader.readAsText(page.file);
                });
            } else if (page.type === 'data') {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    const timeout = setTimeout(() => {
                        reader.abort();
                        reject(new Error('Data processing timeout'));
                    }, 15000);

                    reader.onload = (e) => {
                        clearTimeout(timeout);
                        try {
                            const text = sanitizeText(e.target.result);
                            if (!text) {
                                reject(new Error('Empty data file'));
                                return;
                            }

                            const lines = text.split('\n').filter(line => line.trim());
                            const delimiter = page.file.name.endsWith('.tsv') ? '\t' : ',';
                            
                            if (lines.length < 2) {
                                reject(new Error('Data file must contain headers and at least one row'));
                                return;
                            }

                            const headers = lines[0].split(delimiter).map(h => sanitizeText(h.trim().replace(/^["']|["']$/g, '')));
                            
                            if (headers.length === 0 || headers.every(h => !h)) {
                                reject(new Error('Invalid or empty headers'));
                                return;
                            }

                            const rows = [];
                            for (let i = 1; i < lines.length; i++) {
                                const line = lines[i];
                                const cells = [];
                                let current = '';
                                let inQuotes = false;
                                
                                for (let j = 0; j < line.length; j++) {
                                    const char = line[j];
                                    if (char === '"' || char === "'") {
                                        inQuotes = !inQuotes;
                                    } else if (char === delimiter && !inQuotes) {
                                        cells.push(sanitizeText(current.trim().replace(/^["']|["']$/g, '')));
                                        current = '';
                                    } else {
                                        current += char;
                                    }
                                }
                                cells.push(sanitizeText(current.trim().replace(/^["']|["']$/g, '')));
                                
                                if (cells.length > 0 && cells.some(c => c)) {
                                    rows.push(cells);
                                }
                            }

                            if (rows.length === 0) {
                                reject(new Error('No valid data rows found'));
                                return;
                            }

                            page.content = { type: 'table', headers, rows };
                            page.thumbnailData = text.substring(0, 200);
                            resolve();
                        } catch (error) {
                            reject(new Error('Failed to parse data file: ' + error.message));
                        }
                    };

                    reader.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('Failed to read file'));
                    };

                    reader.readAsText(page.file);
                });
            }
        }

        function getFileType(file) {
            if (SUPPORTED_IMAGE_TYPES.includes(file.type)) {
                return 'image';
            }

            const ext = file.name.split('.').pop().toLowerCase();
            const textExts = ['txt', 'md', 'rtf', 'log'];
            const codeExts = ['js', 'py', 'html', 'css', 'json', 'xml', 'java', 'cpp', 'c', 'php', 'rb', 'go', 'rs', 'ts', 'jsx', 'tsx', 'sh', 'yml', 'yaml'];
            const dataExts = ['csv', 'tsv'];

            if (textExts.includes(ext)) return 'text';
            if (codeExts.includes(ext)) return 'code';
            if (dataExts.includes(ext)) return 'data';
            return 'text';
        }

        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        function getLanguageFromExtension(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const languageMap = {
                'js': 'javascript',
                'jsx': 'jsx',
                'ts': 'typescript',
                'tsx': 'tsx',
                'py': 'python',
                'java': 'java',
                'cpp': 'cpp',
                'c': 'c',
                'cs': 'csharp',
                'php': 'php',
                'rb': 'ruby',
                'go': 'go',
                'rs': 'rust',
                'sh': 'bash',
                'bash': 'bash',
                'json': 'json',
                'yml': 'yaml',
                'yaml': 'yaml',
                'css': 'css',
                'html': 'markup',
                'xml': 'markup',
                'md': 'markdown',
                'sql': 'sql'
            };
            return languageMap[ext] || null;
        }

        function getLanguageDisplayName(language) {
            const displayNames = {
                'javascript': 'JavaScript',
                'typescript': 'TypeScript',
                'jsx': 'React JSX',
                'tsx': 'React TSX',
                'python': 'Python',
                'java': 'Java',
                'cpp': 'C++',
                'c': 'C',
                'csharp': 'C#',
                'php': 'PHP',
                'ruby': 'Ruby',
                'go': 'Go',
                'rust': 'Rust',
                'bash': 'Bash',
                'json': 'JSON',
                'yaml': 'YAML',
                'css': 'CSS',
                'markup': 'HTML/XML',
                'markdown': 'Markdown',
                'sql': 'SQL'
            };
            return displayNames[language] || language.toUpperCase();
        }

        function renderPages() {
            if (pages.length === 0) {
                elements.pagesList.innerHTML = '<div class="no-pages">No pages added yet. Add files or paste content to begin.</div>';
                return;
            }

            elements.pagesList.innerHTML = '';
            pages.forEach((page, index) => {
                const pageEl = document.createElement('div');
                pageEl.className = 'page-item';
                if (page.id === selectedPageId) {
                    pageEl.classList.add('selected');
                }
                if (page.error) {
                    pageEl.classList.add('error');
                }
                pageEl.draggable = true;
                pageEl.dataset.pageId = page.id;

                const preview = document.createElement('div');
                preview.className = 'page-preview';

                if (page.error) {
                    preview.innerHTML = '<div class="error-icon">‚ö†Ô∏è</div>';
                } else if (!page.content) {
                    preview.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
                } else if (page.content.type === 'image') {
                    const img = document.createElement('img');
                    img.src = page.thumbnailData;
                    img.onerror = () => {
                        preview.innerHTML = '<div class="error-icon">‚ö†Ô∏è</div>';
                    };
                    preview.appendChild(img);
                } else {
                    const pre = document.createElement('pre');
                    pre.textContent = page.thumbnailData || '';
                    preview.appendChild(pre);
                }

                const pageNum = document.createElement('div');
                pageNum.className = 'page-number';
                pageNum.textContent = index + 1;
                pageEl.appendChild(pageNum);

                pageEl.appendChild(preview);

                const info = document.createElement('div');
                info.className = 'page-info';

                const details = document.createElement('div');
                const name = document.createElement('div');
                name.className = 'page-name';
                name.textContent = page.name;
                name.title = page.name;
                details.appendChild(name);

                const size = document.createElement('div');
                size.className = 'page-size';
                
                // Add estimated page count for content
                let sizeText = formatFileSize(page.size);
                if (page.content) {
                    const estimatedPages = estimatePDFPages(page);
                    if (estimatedPages > 1) {
                        sizeText += ` ‚Ä¢ ~${estimatedPages} PDF pages`;
                    }
                }
                size.textContent = sizeText;
                details.appendChild(size);

                info.appendChild(details);

                const actions = document.createElement('div');
                actions.className = 'page-actions';

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'page-action-btn delete';
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deletePage(page.id);
                };
                actions.appendChild(deleteBtn);

                info.appendChild(actions);
                pageEl.appendChild(info);

                pageEl.onclick = () => selectPage(page.id);

                pageEl.addEventListener('dragstart', handleDragStart);
                pageEl.addEventListener('dragover', handleDragOver);
                pageEl.addEventListener('drop', handleDrop);
                pageEl.addEventListener('dragend', handleDragEnd);
                
                // Touch events for mobile - passive for better scroll performance
                pageEl.addEventListener('touchstart', handleTouchStart, { passive: true });
                pageEl.addEventListener('touchmove', handleTouchMove, { passive: false });
                pageEl.addEventListener('touchend', handleTouchEnd, { passive: true });

                elements.pagesList.appendChild(pageEl);
            });

            elements.pageCount.textContent = `${pages.length} page${pages.length !== 1 ? 's' : ''}`;
        }

        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const afterElement = getDragAfterElement(elements.pagesList, e.clientY);
            const dragging = document.querySelector('.dragging');
            
            if (dragging && afterElement == null) {
                elements.pagesList.appendChild(dragging);
            } else if (dragging) {
                elements.pagesList.insertBefore(dragging, afterElement);
            }
        }

        function handleDrop(e) {
            e.preventDefault();
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            
            const pageElements = Array.from(elements.pagesList.querySelectorAll('.page-item'));
            const newOrder = pageElements.map(el => el.dataset.pageId);
            
            const reorderedPages = newOrder.map(id => pages.find(p => p.id == id)).filter(p => p);
            pages.length = 0;
            pages.push(...reorderedPages);
            
            renderPages();
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.page-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Touch event support for mobile drag and drop
        let touchStartY = 0;
        let touchStartX = 0;
        let touchElement = null;
        let isDragging = false;
        let dragThreshold = 10; // pixels to move before triggering drag

        function handleTouchStart(e) {
            if (e.target.classList.contains('page-action-btn')) return;
            
            touchElement = e.target.closest('.page-item');
            if (!touchElement) return;
            
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
            isDragging = false;
        }

        function handleTouchMove(e) {
            if (!touchElement) return;
            
            const touch = e.touches[0];
            const deltaY = Math.abs(touch.clientY - touchStartY);
            const deltaX = Math.abs(touch.clientX - touchStartX);
            
            // Only start dragging if moved horizontally more than vertically
            // This allows vertical scrolling while enabling horizontal drag
            if (!isDragging && deltaX > dragThreshold && deltaX > deltaY) {
                isDragging = true;
                touchElement.classList.add('dragging');
            }
            
            // Only prevent default and reorder if actively dragging
            if (isDragging) {
                e.preventDefault();
                
                const afterElement = getDragAfterElement(elements.pagesList, touch.clientY);
                
                if (afterElement == null) {
                    elements.pagesList.appendChild(touchElement);
                } else {
                    elements.pagesList.insertBefore(touchElement, afterElement);
                }
            }
        }

        function handleTouchEnd(e) {
            if (!touchElement) return;
            
            touchElement.classList.remove('dragging');
            
            if (isDragging) {
                // Only reorder if we were actually dragging
                const pageElements = Array.from(elements.pagesList.querySelectorAll('.page-item'));
                const newOrder = pageElements.map(el => el.dataset.pageId);
                
                const reorderedPages = newOrder.map(id => pages.find(p => p.id == id)).filter(p => p);
                pages.length = 0;
                pages.push(...reorderedPages);
                
                renderPages();
            }
            
            touchElement = null;
            isDragging = false;
        }

        function selectPage(pageId) {
            selectedPageId = pageId;
            const page = pages.find(p => p.id === pageId);
            
            if (!page) {
                selectedPageId = null;
                renderPages();
                return;
            }

            renderPages();
            
            if (page.error) {
                elements.previewArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Failed to load page</div>
                        <div class="empty-state-hint">${page.error}</div>
                    </div>
                `;
            } else if (!page.content) {
                elements.previewArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><div class="loading-spinner"></div></div>
                        <div class="empty-state-text">Processing...</div>
                    </div>
                `;
            } else {
                renderPreview(page);
            }
        }

        function renderPreview(page) {
            if (!page || !page.content) {
                console.log('renderPreview: No page or content', page);
                return;
            }
            
            console.log('renderPreview called for:', page.name, 'type:', page.content.type);

            const container = document.createElement('div');
            container.className = 'preview-container';

            try {
                if (page.content.type === 'image') {
                    const img = document.createElement('img');
                    img.src = page.content.data;
                    img.onerror = () => {
                        elements.previewArea.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ö†Ô∏è</div>
                                <div class="empty-state-text">Failed to display image</div>
                            </div>
                        `;
                    };
                    container.appendChild(img);
                } else if (page.content.type === 'text' || page.content.type === 'code') {
                    const language = getLanguageFromExtension(page.name);
                    
                    // Estimate page count for text content
                    const estimatedPages = estimatePDFPages(page);
                    
                    if (estimatedPages > 1) {
                        const pageInfo = document.createElement('div');
                        pageInfo.style.cssText = 'background: #4a9eff; color: white; padding: 8px 12px; margin-bottom: 12px; font-size: 11px; text-align: center; font-weight: 500;';
                        pageInfo.textContent = `üìÑ This content will span approximately ${estimatedPages} pages in the PDF`;
                        container.appendChild(pageInfo);
                    }
                    
                    // If it's a code file, show it with simple formatting
                    if (page.content.type === 'code' && language) {
                        const codeContainer = document.createElement('div');
                        codeContainer.className = 'code-container';
                        
                        // Add code header with language badge
                        const header = document.createElement('div');
                        header.className = 'code-header';
                        header.innerHTML = `
                            <span class="code-language">${getLanguageDisplayName(language)}</span>
                            <span>${page.name}</span>
                        `;
                        codeContainer.appendChild(header);
                        
                        // Add plain code without syntax highlighting
                        const pre = document.createElement('pre');
                        pre.style.cssText = 'background: #f5f5f5; padding: 12px; overflow-x: auto; ' +
                                           'font-family: "Courier New", "Consolas", monospace; ' +
                                           'font-size: 12px; line-height: 1.5; color: #000; ' +
                                           'white-space: pre; tab-size: 4; -moz-tab-size: 4;';
                        pre.textContent = page.content.data;
                        codeContainer.appendChild(pre);
                        
                        container.appendChild(codeContainer);
                    } else {
                        // Plain text without syntax highlighting
                        const pre = document.createElement('pre');
                        pre.style.cssText = 'white-space: pre-wrap; word-wrap: break-word; ' +
                                           'font-family: "Courier New", monospace; font-size: 12px; ' +
                                           'line-height: 1.6; color: #000; tab-size: 4; -moz-tab-size: 4;';
                        pre.textContent = page.content.data;
                        container.appendChild(pre);
                    }
                } else if (page.content.type === 'table') {
                    const table = document.createElement('table');
                    
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    page.content.headers.forEach(header => {
                        const th = document.createElement('th');
                        th.textContent = header;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');
                    page.content.rows.forEach(row => {
                        const tr = document.createElement('tr');
                        row.forEach(cell => {
                            const td = document.createElement('td');
                            td.textContent = cell;
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);

                    container.appendChild(table);
                }

                elements.previewArea.innerHTML = '';
                elements.previewArea.appendChild(container);
            } catch (error) {
                console.error('Preview render error:', error);
                elements.previewArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Failed to render preview</div>
                    </div>
                `;
            }
        }

        function deletePage(pageId) {
            const index = pages.findIndex(p => p.id === pageId);
            if (index !== -1) {
                pages.splice(index, 1);
                
                if (selectedPageId === pageId) {
                    selectedPageId = pages.length > 0 ? pages[0].id : null;
                    if (selectedPageId) {
                        const page = pages[0];
                        if (page.content && !page.error) {
                            renderPreview(page);
                        }
                    } else {
                        elements.previewArea.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìÑ</div>
                                <div class="empty-state-text">No page selected</div>
                                <div class="empty-state-hint">Select a page from the sidebar to preview</div>
                            </div>
                        `;
                    }
                }
                
                renderPages();
                updateUIState();
            }
        }

        function clearAll() {
            pages.length = 0;
            selectedPageId = null;
            renderPages();
            elements.previewArea.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìÑ</div>
                    <div class="empty-state-text">No page selected</div>
                    <div class="empty-state-hint">Select a page from the sidebar to preview</div>
                </div>
            `;
            updateUIState();
            hideModal();
        }

        function updateUIState() {
            const hasPages = pages.length > 0;
            const hasValidPages = pages.some(p => p.content && !p.error);
            elements.exportBtn.disabled = !hasValidPages;
            elements.clearAllBtn.disabled = !hasPages;
        }

        async function exportPDF() {
            const validPages = pages.filter(p => p.content && !p.error);
            
            if (validPages.length === 0) {
                showToast('No valid pages to export', 'error');
                return;
            }

            elements.exportBtn.disabled = true;
            elements.exportBtnText.innerHTML = '<div class="loading-spinner"></div><span>Exporting...</span>';

            try {
                const title = sanitizeText(elements.pdfTitle.value) || 'Untitled Document';
                const pageSize = pageSizes[elements.pageSize.value] || 'A4';
                const addPageNums = elements.addPageNumbers.checked;

                let docDefinition = {
                    pageSize: pageSize,
                    pageMargins: [40, 60, 40, 60],
                    info: {
                        title: title.substring(0, 100),
                        author: 'Universal PDF Converter',
                        subject: 'Converted Document',
                        creator: 'Universal PDF Converter'
                    },
                    defaultStyle: {
                        font: 'Roboto'
                    },
                    styles: {
                        code: {
                            fontSize: 9,
                            lineHeight: 1.4,
                            preserveLeadingSpaces: true
                        }
                    },
                    content: []
                };

                for (let i = 0; i < validPages.length; i++) {
                    const page = validPages[i];
                    
                    if (i > 0) {
                        docDefinition.content.push({ text: '', pageBreak: 'before' });
                    }

                    try {
                        if (page.content.type === 'image') {
                            if (!page.content.data) {
                                throw new Error('Image data is missing');
                            }
                            const maxWidth = pageSize === 'A4' ? 500 : 550;
                            const scaledWidth = Math.min(maxWidth, page.content.width * 0.75);
                            docDefinition.content.push({
                                image: page.content.data,
                                width: scaledWidth,
                                alignment: 'center'
                            });
                        } else if (page.content.type === 'text' || page.content.type === 'code') {
                            if (!page.content.data) {
                                throw new Error('Text data is missing');
                            }
                            
                            // For code files, add a header with the language
                            if (page.content.type === 'code') {
                                const language = getLanguageFromExtension(page.name);
                                if (language) {
                                    docDefinition.content.push({
                                        text: getLanguageDisplayName(language) + ' - ' + page.name,
                                        fontSize: 11,
                                        bold: true,
                                        color: '#4a9eff',
                                        margin: [0, 0, 0, 8]
                                    });
                                }
                            }
                            
                            // Join lines with newlines instead of passing array
                            docDefinition.content.push({
                                text: page.content.data.split('\n').join('\n'),
                                style: 'code',
                                background: page.content.type === 'code' ? '#f5f5f5' : null,
                                margin: [0, 0, 0, 8],
                                preserveLeadingSpaces: true
                            });
                        } else if (page.content.type === 'table') {
                            if (!page.content.headers || !page.content.rows) {
                                throw new Error('Table data is incomplete');
                            }
                            const tableBody = [
                                page.content.headers.map(h => ({
                                    text: h || '',
                                    style: 'tableHeader',
                                    bold: true
                                }))
                            ];

                            page.content.rows.forEach(row => {
                                tableBody.push(row.map(cell => ({
                                    text: String(cell || ''),
                                    fontSize: 9
                                })));
                            });

                            docDefinition.content.push({
                                table: {
                                    headerRows: 1,
                                    widths: Array(page.content.headers.length).fill('auto'),
                                    body: tableBody
                                },
                                layout: {
                                    fillColor: function (rowIndex) {
                                        return rowIndex === 0 ? '#f0f0f0' : null;
                                    }
                                }
                            });

                            docDefinition.styles.tableHeader = {
                                bold: true,
                                fontSize: 10,
                                color: 'black'
                            };
                        }
                    } catch (pageError) {
                        console.error('Error adding page ' + (i + 1) + ' to PDF:', pageError);
                        showToast('Warning: Page ' + (i + 1) + ' could not be added', 'error');
                    }
                }

                // Validate that we have actual content to export
                if (docDefinition.content.length === 0) {
                    throw new Error('No content could be generated from the pages');
                }

                // Header function to ensure it appears on all pages
                docDefinition.header = function(currentPage, pageCount) {
                    return {
                        text: title,
                        fontSize: 14,
                        bold: true,
                        alignment: 'center',
                        margin: [0, 20, 0, 0]
                    };
                };

                // Footer with page numbers
                if (addPageNums) {
                    docDefinition.footer = function(currentPage, pageCount) {
                        return {
                            text: 'Page ' + currentPage + ' of ' + pageCount,
                            alignment: 'center',
                            fontSize: 9,
                            margin: [0, 10, 0, 0],
                            color: '#000000'
                        };
                    };
                }

                // Validate pdfMake is loaded
                if (typeof pdfMake === 'undefined') {
                    throw new Error('PDF library not loaded. Please refresh the page.');
                }

                const pdfDocGenerator = pdfMake.createPdf(docDefinition);
                
                const safeFilename = title.replace(/[^a-z0-9]/gi, '_').toLowerCase().substring(0, 50) + '.pdf';
                
                pdfDocGenerator.download(safeFilename, () => {
                    showToast('PDF exported successfully', 'success');
                    elements.exportBtn.disabled = false;
                    elements.exportBtnText.textContent = 'Export PDF';
                }, (error) => {
                    console.error('PDF download error:', error);
                    showToast('Download failed: ' + (error?.message || 'Unknown error'), 'error');
                    elements.exportBtn.disabled = false;
                    elements.exportBtnText.textContent = 'Export PDF';
                });

            } catch (error) {
                console.error('Export error:', error);
                showToast('Export failed: ' + error.message, 'error');
                elements.exportBtn.disabled = false;
                elements.exportBtnText.textContent = 'Export PDF';
            }
        }

        function showToast(message, type = 'success') {
            if (!message) return;
            elements.toast.textContent = message.substring(0, 200);
            elements.toast.className = 'toast show ' + type;
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }

        function showConfirmModal(title, content, onConfirm) {
            elements.modalTitle.textContent = title;
            elements.modalContent.textContent = content;
            elements.modalOverlay.classList.add('show');
            
            elements.modalConfirm.onclick = () => {
                if (onConfirm) onConfirm();
            };
        }

        function hideModal() {
            elements.modalOverlay.classList.remove('show');
        }

        elements.modalOverlay.addEventListener('click', (e) => {
            if (e.target === elements.modalOverlay) {
                hideModal();
            }
        });
    </script>
</body>
</html>
